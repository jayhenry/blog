name: md2zhihu
on: [push]
jobs:
  md2zhihu:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML k3color k3down2 k3fs k3git k3handy typing_extensions urllib3 pygments
    - name: Install md2zhihu
      run: |
        pip install git+https://github.com/drmingdrmer/md2zhihu.git@main
    - name: Install mermaid
      run: npm install @mermaid-js/mermaid-cli@10.2.2
    - name: Install pandoc and graphviz
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc graphviz
    - name: Run md2zhihu
      run: |
        export PATH="$PWD/node_modules/.bin:$PATH"
        echo 'asset repo: https://${{ secrets.GITEE_PUSH_REPO }}@gitee.com/henryzhao28/blog.git@${{ github.ref_name }}-md2zhihu-asset'
        md2zhihu \
          --repo 'https://${{ secrets.GITEE_PUSH_REPO }}@gitee.com/henryzhao28/blog.git@${{ github.ref_name }}-md2zhihu-asset' \
          --code-width 600 \
          --platform zhihu \
          --md-output _md2zhihu/ \
          articles/**/*.md
    - name: Commit and push results
      run: |
        if [ -d "_md2zhihu" ] && [ "$(ls -A _md2zhihu)" ]; then
          git add _md2zhihu
          if git diff-index --quiet HEAD --; then
            echo "Nothing to commit"
          else
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_USERNAME}/blog.git
            git commit -m "Convert markdown to zhihu format"
            git push -f origin HEAD:${{ github.ref_name }}-md2zhihu
            echo "Results pushed to branch: ${{ github.ref_name }}-md2zhihu"
          fi
        else
          echo "No output files generated"
        fi
      env:
        GITHUB_USERNAME: ${{ github.repository_owner }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}